name: Daily API Tests

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´3ç‚¹æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´11ç‚¹ï¼‰
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'æµ‹è¯•ç¯å¢ƒ'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - dev
          - pre
      tags:
        description: 'æµ‹è¯•æ ‡ç­¾'
        required: false
        default: ''
        type: string

env:
  PYTHON_VERSION: '3.9'
  ALLURE_RESULTS: './allure-results'
  ALLURE_REPORT: './allure-report'

jobs:
  api-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        environment: ['test', 'dev', 'pre']
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        # å®‰è£…æµ‹è¯•ä¾èµ–
        pip install pytest allure-pytest pytest-html loguru requests
        # å®‰è£…Allureå‘½ä»¤è¡Œå·¥å…·
        sudo apt-get update
        sudo apt-get install -y openjdk-11-jre
        wget https://github.com/allure-framework/allure2/releases/download/2.20.1/allure-2.20.1.tgz
        tar -zxvf allure-2.20.1.tgz
        sudo mv allure-2.20.1 /opt/allure
        sudo ln -s /opt/allure/bin/allure /usr/bin/allure
    
    - name: Create environment config
      run: |
        # æ ¹æ®ç¯å¢ƒè®¾ç½®APIåŸºç¡€URL
        case "${{ matrix.environment }}" in
          "test")
            echo "API_BASE_URL=https://test-api.example.com" >> $GITHUB_ENV
            ;;
          "dev")
            echo "API_BASE_URL=https://dev-api.example.com" >> $GITHUB_ENV
            ;;
          "pre")
            echo "API_BASE_URL=https://pre-api.example.com" >> $GITHUB_ENV
            ;;
        esac
        echo "TEST_ENV=${{ matrix.environment }}" >> $GITHUB_ENV
    
    - name: Run tests with custom env
      id: run-tests
      continue-on-error: true
      run: |
        # æ„å»ºpytestå‘½ä»¤ï¼ˆä½¿ç”¨æ‚¨çš„è„šæœ¬æ–¹å¼ï¼‰
        # æ³¨æ„ï¼šè¿™é‡Œç›´æ¥è°ƒç”¨æ‚¨çš„è„šæœ¬ï¼Œè€Œä¸æ˜¯ä½¿ç”¨pytestå‘½ä»¤
        echo "å¼€å§‹æ‰§è¡Œæµ‹è¯•ï¼Œç¯å¢ƒ: ${{ matrix.environment }}"
        
        # æ–¹æ³•1ï¼šç›´æ¥è°ƒç”¨æ‚¨çš„è„šæœ¬
        python run_tests.py ${{ matrix.environment }}
        
        # æˆ–è€…æ–¹æ³•2ï¼šç›´æ¥ä½¿ç”¨pytestå‘½ä»¤ï¼ˆå¦‚æœæ‚¨æœ‰conftest.pyï¼‰
        # pytest -v -s --alluredir=${{ env.ALLURE_RESULTS }} --clean-alluredir --env=${{ matrix.environment }} test_basecase.py
        
        # è®°å½•é€€å‡ºçŠ¶æ€
        echo "exit_code=$?" >> $GITHUB_OUTPUT
        
        # ç»Ÿè®¡æµ‹è¯•ç»“æœ
        if [ -d "${{ env.ALLURE_RESULTS }}" ]; then
          echo "æµ‹è¯•ç»“æœç›®å½•å·²åˆ›å»º"
          # ä¿å­˜ç¯å¢ƒä¿¡æ¯
          echo '{"environment": "${{ matrix.environment }}", "timestamp": "'$(date -Is)'"}' > ${{ env.ALLURE_RESULTS }}/environment.json
        fi
    
    - name: Generate Allure report
      if: always()
      run: |
        # ç”ŸæˆAllureæŠ¥å‘Š
        if [ -d "${{ env.ALLURE_RESULTS }}" ] && [ "$(ls -A ${{ env.ALLURE_RESULTS }})" ]; then
          echo "ç”ŸæˆAllureæŠ¥å‘Š..."
          allure generate ${{ env.ALLURE_RESULTS }} -o ${{ env.ALLURE_REPORT }} --clean
          
          # æ·»åŠ æ‰§è¡Œå™¨ä¿¡æ¯
          cat > ${{ env.ALLURE_REPORT }}/executor.json << EOF
          {
            "name": "GitHub Actions",
            "type": "github",
            "buildName": "Daily API Test - ${{ matrix.environment }}",
            "buildUrl": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "reportUrl": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts"
          }
          EOF
        else
          echo "æ²¡æœ‰æµ‹è¯•ç»“æœå¯ç”ŸæˆæŠ¥å‘Š"
        fi
    
    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results-${{ matrix.environment }}
        path: |
          ${{ env.ALLURE_RESULTS }}/
          ${{ env.ALLURE_REPORT }}/
        retention-days: 30
    
    - name: Prepare summary data
      if: always()
      id: summary
      run: |
        # å‡†å¤‡æµ‹è¯•æ‘˜è¦ä¿¡æ¯
        if [ -d "${{ env.ALLURE_RESULTS }}" ]; then
          # ç»Ÿè®¡æµ‹è¯•ç»“æœæ–‡ä»¶
          TOTAL_FILES=$(find ${{ env.ALLURE_RESULTS }} -name "*.json" -type f | wc -l)
          echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT
          echo "test_environment=${{ matrix.environment }}" >> $GITHUB_OUTPUT
          echo "run_id=${{ github.run_id }}" >> $GITHUB_OUTPUT
        fi
    
    - name: Send DingTalk notification
      if: always()
      env:
        DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
        DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
      run: |
        # å‘é€é’‰é’‰é€šçŸ¥
        python -c "
import os
import sys
import json
import time
import hmac
import hashlib
import base64
import urllib.parse
import requests
from datetime import datetime

# è·å–ç¯å¢ƒå˜é‡
webhook = os.getenv('DINGTALK_WEBHOOK')
secret = os.getenv('DINGTALK_SECRET')
environment = '${{ matrix.environment }}'
run_id = '${{ github.run_id }}'
repository = '${{ github.repository }}'
actor = '${{ github.actor }}'

if not webhook:
    print('âš ï¸ é’‰é’‰Webhookæœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥')
    sys.exit(0)

# ç”Ÿæˆç­¾å
timestamp = str(round(time.time() * 1000))
if secret:
    secret_enc = secret.encode('utf-8')
    string_to_sign = f'{timestamp}\\n{secret}'
    string_to_sign_enc = string_to_sign.encode('utf-8')
    hmac_code = hmac.new(secret_enc, string_to_sign_enc, digestmod=hashlib.sha256).digest()
    sign = urllib.parse.quote_plus(base64.b64encode(hmac_code))
else:
    sign = ''

# æ„å»ºURL
actions_url = f'https://github.com/{repository}/actions/runs/{run_id}'
artifact_url = f'{actions_url}/artifacts'

# æ ¹æ®é€€å‡ºçŠ¶æ€åˆ¤æ–­ç»“æœ
exit_code = int('${{ steps.run-tests.outputs.exit_code || 0 }}')
if exit_code == 0:
    status = 'âœ… æˆåŠŸ'
    status_color = '#00FF00'
else:
    status = 'âŒ å¤±è´¥'
    status_color = '#FF0000'

# æ„å»ºæ¶ˆæ¯
current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

message = {
    'msgtype': 'markdown',
    'markdown': {
        'title': 'APIè‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Š',
        'text': f'''## ğŸ§ª APIè‡ªåŠ¨åŒ–æµ‹è¯•å®Œæˆé€šçŸ¥

**ğŸ“… æ‰§è¡Œæ—¶é—´**: {current_time}  
**ğŸ·ï¸ æµ‹è¯•ç¯å¢ƒ**: {environment.upper()}  
**ğŸ‘¤ è§¦å‘äººå‘˜**: {actor or 'å®šæ—¶ä»»åŠ¡'}  
**ğŸ“Š æµ‹è¯•çŠ¶æ€**: {status}  

### ğŸ”— ç›¸å…³é“¾æ¥
- ğŸ“‹ [æŸ¥çœ‹æ‰§è¡Œè¯¦æƒ…]({actions_url})
- ğŸ“¦ [ä¸‹è½½æµ‹è¯•æŠ¥å‘Š]({artifact_url})
- ğŸ“ [æŸ¥çœ‹ä»£ç ä»“åº“](https://github.com/{repository})

### âš™ï¸ æµ‹è¯•é…ç½®
- ç¯å¢ƒå‚æ•°: \`--env={environment}\`
- æ‰§è¡Œå‘½ä»¤: \`pytest --env={environment} --alluredir=./allure-results --clean-alluredir\`
- Pythonç‰ˆæœ¬: ${{ env.PYTHON_VERSION }}

### ğŸ“ æ‰§è¡Œè¯´æ˜
æµ‹è¯•å·²é€šè¿‡GitHub Actionsè‡ªåŠ¨æ‰§è¡Œå®Œæˆã€‚  
å¦‚éœ€é‡æ–°æ‰§è¡Œç‰¹å®šç¯å¢ƒçš„æµ‹è¯•ï¼Œè¯·åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨è§¦å‘å·¥ä½œæµã€‚

---
*æ­¤æ¶ˆæ¯ç”±GitHub Actionsè‡ªåŠ¨å‘é€*'''
    },
    'at': {
        'atMobiles': [],
        'isAtAll': False
    }
}

# å‘é€è¯·æ±‚
params = f'timestamp={timestamp}'
if sign:
    params += f'&sign={sign}'

webhook_url = f'{webhook}?{params}'
try:
    response = requests.post(
        webhook_url,
        headers={'Content-Type': 'application/json'},
        data=json.dumps(message),
        timeout=10
    )
    
    if response.status_code == 200:
        print('âœ… é’‰é’‰é€šçŸ¥å‘é€æˆåŠŸ')
    else:
        print(f'âŒ é’‰é’‰é€šçŸ¥å‘é€å¤±è´¥: {response.text}')
except Exception as e:
    print(f'âŒ å‘é€é’‰é’‰é€šçŸ¥æ—¶å‡ºé”™: {str(e)}')
"
